---
title: "Exploring Water Temp"
author: "Cammie Moore, Jack Killeen, Shaochong Xue"
date: "2025-04-04"
output: html_document
editor_options: 
  chunk_output_type: console
---

*Link to GitHub repository:https://github.com/AllenX0627/MooreXueKilleen.git *

# 0. Set up R environment

```{r setup, include=FALSE}
rm(list=ls())

library(tidyverse)
library(readxl)
library(readr)
library(here)
library(dataRetrieval)
library(sf)
library(mapview)
library(tidycensus)
library(tigris)
library(prism)
library(raster)
library(GGally)
library(dplyr)
library(car)
library(ggplot2)


options(scipen = 999)

```

# 1. Get states socioeconomic data

```{r census.gov, include=FALSE}

income <- get_acs(
  geography = "county",
  variables = c(total_pop = "B01003_001", med_income = "B19013_001", poverty = "B17001_002", employed_mine = "C24030_003", total_employed = "C24030_001", employed_constr = "C24030_005", employed_manu = "C24030_006"), 
  state = c("NC", "GA", "SC", "TN"),
  year = 2023,
  survey = "acs5", # american community survey 5 year
  geometry = TRUE
)

income <- income|> #pivot wider to get the data out of the variable column
  select(!moe)|>
  pivot_wider(names_from = variable, 
              values_from = estimate)
census_tidy <- income|> #finding percentages of values for tidy df
  mutate(
    per_pov = (poverty/total_pop)*100,
    per_industry = ((employed_mine+employed_constr+employed_manu)/total_employed)*100
  )|>
  select(GEOID, NAME, total_pop, med_income, per_pov, per_industry)
# above code got percent poverty rates and percent industry rates for each county. "Industry" is defined as someone reporting on the ACS as working in construction, mining, or manufacturing

```

# 2. Get water temperature data for sites

```{r sites reading, include=FALSE}
sites.df <- read.delim("Data/site_list.txt", comment.char = "#", stringsAsFactors = FALSE) # the dates of this file is from 2025-04-01 to 2025-04-02

sites.df <- renameNWISColumns(sites.df) # renaming
sites.df$site_no <- as.factor(sites.df$site_no)
sites.df$Temp_C <- as.numeric(sites.df$Temp_C)
sites.df <- drop_na(sites.df)



sites.tidy.df <- sites.df|> #mean water temperature from past seven days for each site
  group_by(site_no)|>
  summarise(mean_temp_C = mean(Temp_C, na.rm=TRUE))|> # water temp in degrees Celsius
  filter(!is.na(mean_temp_C))

list_sites <- as.list(sites.tidy.df$site_no) #list of sites only
site_info <- readNWISsite(unlist(list_sites)) #geo references for list of sites datum NAD83
site_info <- site_info |>
  select(site_no, dec_lat_va, dec_long_va)

sites_geo <- left_join(sites.tidy.df, site_info, by = "site_no") #joining sites

sites.shp <- sites_geo |> 
  st_as_sf(
    coords = c('dec_long_va','dec_lat_va'),
    crs=4326
    )

```

```{r writing .shp for gauges, eval=FALSE} 
st_write( # change eval to TRUE the first time running code to write the file
  sites.shp,
  here("Data/sites.shp"),
  driver='ESRI Shapefile',
  append = FALSE
  )
mapview(sites.shp)
```

```{r exploring mapping rivers and counties, include=FALSE}
census_tidy.utm <- st_transform(census_tidy, 32617)
sites.utm <- st_transform(sites.shp, 32617)

rivers_county.plot <- ggplot()+
  geom_sf(data = census_tidy.utm, aes(fill = per_industry))+
  geom_sf(data = sites.utm, color = "green")+
  scale_fill_continuous(low = "red", high = "lightyellow")

rivers_county.plot
```

# 3. Get other environmental data for sites

```{r flow data}
flow_data <- readNWISdata(
  service = "dv",
  site = sites.tidy.df$site_no,
  parameterCd = "00060",
  startDate = "2025-04-01",
  endDate = "2025-04-02"
)

flow_data <- renameNWISColumns(flow_data)

flow_tidy <- flow_data %>%
  group_by(site_no) %>%
  summarise(mean_flow = mean(Flow, na.rm = TRUE)) %>%
  filter(!is.na(mean_flow))

head(flow_tidy)

```


```{r elevation data}
# use elevatr package to get elevation data for each sites
library(elevatr)

elev.df <- get_elev_point(sites.utm, src = "aws")
```

```{r use PRISM package to get air temp data}
options(prism.path = "Data/PRISM")

get_prism_dailys(
  type = "tmean",
  minDate = "2025-04-01",
  maxDate = "2025-04-02",
  keepZip = FALSE
)

```

```{r get tmean for each sites}
# read PRISM raster file
tmean_0401 <- raster("Data/PRISM/PRISM_tmean_early_4kmD2_20250401_bil/PRISM_tmean_early_4kmD2_20250401_bil.bil")
tmean_0402 <- raster("Data/PRISM/PRISM_tmean_early_4kmD2_20250402_bil/PRISM_tmean_early_4kmD2_20250402_bil.bil")

# get temp for each sites by coordinate 
temp_0401 <- raster::extract(tmean_0401, sites.shp)
temp_0402 <- raster::extract(tmean_0402, sites.shp)

# calculate t mean
temp_mean <- rowMeans(cbind(temp_0401, temp_0402), na.rm = TRUE)
temp_mean

```

# 4. Combine data

```{r st join, include=FALSE}
#st join to get pop, income, pov, industry for each sites
sites.county <- st_join(sites.utm, census_tidy.utm)
head(sites.county)
```


```{r combine all data}
sites.full <- sites.county %>%
  st_drop_geometry() %>%
  select(site_no, mean_temp_C, total_pop, med_income, per_pov, per_industry) %>%
  left_join(flow_tidy, by = "site_no") %>%
  mutate(elev = elev.df$elevation,
         mean_t_air = temp_mean
         ) %>%
  drop_na()
  
head(sites.full) # please use this df for analysis!
```

# 5. Linear Regressios

```{r scatter plot matrix}
sites_scatterplot <- sites.full %>%
  select(-site_no)

ggpairs(sites_scatterplot, title = "Figure 1: SScatterplot Matrix of Water Temperature and Predictors", axisLabels = "show")
```

The matrix shows that:

Air temperature is positively correlated with water temperature (r = 0.635).

Elevation is negatively correlated with water temperature (r = -0.646).

Poverty rate shows a weak positive correlation with water temperature (r = 0.247).

Other variables, such as flow, industrial employment percentage, and median income, do not show significant correlations with water temperature. 

Elevation and flow are highly skewed, we applied log transformations to improve linearity for regression.

```{r log transformation}
sites.full.log <- sites.full %>%
  mutate(
    log_flow = log(mean_flow),
    log_elev = log(elev)
  )
head(sites.full.log)
```

```{r scatter plot matrix 2}
sites_scatterplot_2 <- sites.full.log %>%
  select(-site_no, -mean_flow, -elev)

ggpairs(sites_scatterplot_2, title = "Figure 2: SScatterplot Matrix of Water Temperature and Predictors (Log Transformation)", axisLabels = "show")
```

After applying log transformations to elevation and flow, the overall patterns in the scatterplot matrix did not change much.

```{r linear model}
model_1 <- lm(mean_temp_C ~ mean_t_air + log_flow + log_elev + per_pov + per_industry + med_income, 
                 data = sites.full.log)
summary(model_1)
```

According to the linear model, air temperature, stream flow, elevation, and poverty rate were significant predictors of water temperature.

Every 1°C increase in air temperature is associated with 0.35°C increased in water temperature (p = 0.0124).

Every 1% increase in the flow is associated with 0.0034°C decrease in water temperature (p = 0.00019).

Every 1% increase in the flow is associated with 0.0092°C decrease in water temperature (p = 0.0055).

Every 1% increase in the poverty rate is associated with 0.18°C increase in water temperature (p = 0.0213).

Industrial employment and median income were not significantly related to water temperature.

The model explained about 48% of the variation in water temperature across our study sites (Adjusted R² = 0.478), suggesting a moderately strong fit.

```{r VIF}
vif(model_1)
```

VIF values for all predictors were below 5, indicating no serious multicollinearity concerns in the model.

```{r AIC to select variables}
model_2 <- step(model_1, direction = "both")

summary(model_2)

```

```{r}
AIC(model_1, model_2)
```

We used AIC to select variables, reducing the linear regression model.The final model included air temperature, flow, elevation, and poverty rate as predictors.

The reduced model has a slightly higher Adjusted R² (0.480 vs 0.478) and lower AIC (514 vs 517), indicating a better fit with fewer predictors.

# 6. 


#### Data Citation
Oliver, S.K., Appling, A., Watkins, D., Atshan, R., and Read, J., 2024, Compilation of multi-agency water temperature observations for U.S. streams, 1894-2022: U.S. Geological Survey data release, https://doi.org/10.5066/P9EMWZ35.



